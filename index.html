<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatbot AI UMPIRE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com; connect-src 'self'; style-src 'self' 'unsafe-inline';">
  <style>
    /* [Twoje style pozostają bez zmian — skrócone tutaj dla przejrzystości] */
  </style>
</head>
<body>
  <div id="chat-app" class="chat-container">
    <div id="messages-area" class="messages-area"></div>
    <div class="p-4 border-t border-gray-700">
      <div id="options-area" class="options-area"></div>
      <div class="input-area">
        <input type="text" id="user-input" class="text-input" placeholder="Napisz swoją wiadomość..." />
        <button id="send-button" class="send-button">Wyślij</button>
      </div>
    </div>
  </div>

  <script>
    const messagesArea = document.getElementById('messages-area');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const optionsArea = document.getElementById('options-area');

    let messages = [];
    let isLoading = false;
    let options = [];

    const sanitizeText = (text) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br/>');
    };

    const scrollToBottom = () => {
      messagesArea.scrollTop = messagesArea.scrollHeight;
    };

    const renderMessages = () => {
      messagesArea.innerHTML = '';
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.sender}`;
        messageDiv.innerHTML = sanitizeText(msg.text);
        messagesArea.appendChild(messageDiv);
      });

      if (isLoading) {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message bot';
        loadingDiv.innerHTML = `
          <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
          </div>`;
        messagesArea.appendChild(loadingDiv);
      }
      scrollToBottom();
    };

    const renderOptions = () => {
      optionsArea.innerHTML = '';
      options.forEach(optionText => {
        const button = document.createElement('button');
        button.className = 'option-button';
        button.textContent = optionText;
        button.onclick = () => handleOptionClick(optionText);
        optionsArea.appendChild(button);
      });
    };

    const initializeChat = () => {
      messages = [{ sender: 'bot', text: 'Witaj! Jestem Twoim asystentem AI. Z jakim problemem z platformą UMPIRE się zmagasz?' }];
      options = [
        'Problemy z logowaniem lub dostępem do panelu UMPIRE (CMS)',
        'Problemy z dodawaniem lub edycją treści (Artykuły, Wydarzenia, Profile)',
        'Problemy z wyświetlaniem zdjęć lub multimediów w UMPIRE',
        'Inne problemy z platformą UMPIRE',
        '✨ Wygeneruj opis zgłoszenia do Jira'
      ];
      renderMessages();
      renderOptions();
    };

    const handleSendMessage = async (text) => {
      if (!text.trim() || isLoading) return;

      messages.push({ sender: 'user', text });
      userInput.value = '';
      isLoading = true;
      options = [];
      renderMessages();
      renderOptions();
      sendButton.disabled = true;
      userInput.disabled = true;

      try {
        const prompt = `...`; // ← Wstaw swój prompt z instrukcjami (skrócony tu dla przejrzystości)

        const response = await fetch('/api/gemini-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }]
          })
        });

        const result = await response.json();
        let botText = "Przepraszam, wystąpił problem z wygenerowaniem odpowiedzi.";

        const textFromModel = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (textFromModel) botText = textFromModel;

        messages.push({ sender: 'bot', text: botText });
        options = ['Zacznij od nowa', 'Zgłoś problem do Jira (jeśli nie rozwiązano)'];

      } catch (error) {
        console.error("Błąd:", error);
        messages.push({ sender: 'bot', text: 'Przepraszam, wystąpił błąd. Spróbuj ponownie.' });
        options = ['Zacznij od nowa', 'Zgłoś problem do Jira (jeśli nie rozwiązano)'];
      } finally {
        isLoading = false;
        sendButton.disabled = false;
        userInput.disabled = false;
        renderMessages();
        renderOptions();
      }
    };

    const generateJiraTicketDescription = async () => {
      isLoading = true;
      options = [];
      renderMessages();
      renderOptions();
      sendButton.disabled = true;
      userInput.disabled = true;

      try {
        const recentMessages = messages.slice(-10); // ograniczenie historii
        const chatHistory = recentMessages.map(msg =>
          `${msg.sender === 'user' ? 'Użytkownik' : 'Asystent'}: ${msg.text}`
        ).join('\n');

        const prompt = `...`; // ← Wstaw prompt Jira (skrócony tu dla przejrzystości)

        const response = await fetch('/api/gemini-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text: prompt }] }]
          })
        });

        const result = await response.json();
        let description = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Nie udało się wygenerować opisu.";

        messages.push({
          sender: 'bot',
          text: `Oto propozycja opisu zgłoszenia do Jira:<br/><br/><pre class="bg-gray-800 p-3 rounded-md overflow-x-auto text-sm">${sanitizeText(description)}</pre>`
        });
        options = ['Zacznij od nowa', 'Zgłoś problem do Jira (jeśli nie rozwiązano)'];

      } catch (err) {
        console.error("Jira opis error:", err);
        messages.push({ sender: 'bot', text: 'Wystąpił błąd przy generowaniu opisu Jira.' });
        options = ['Zacznij od nowa'];
      } finally {
        isLoading = false;
        sendButton.disabled = false;
        userInput.disabled = false;
        renderMessages();
        renderOptions();
      }
    };

    const handleOptionClick = (optionText) => {
      if (optionText === 'Zacznij od nowa') {
        initializeChat();
      } else if (optionText === 'Zgłoś problem do Jira (jeśli nie rozwiązano)') {
        messages.push({ sender: 'user', text: optionText });
        messages.push({ sender: 'bot', text: 'Użyj tego linku: [Zgłoś problem w Jira](LINK_DO_OGÓLNEGO_JIRA_SUPPORT_UMPIRE)' });
        options = [];
        renderMessages();
        renderOptions();
      } else if (optionText === '✨ Wygeneruj opis zgłoszenia do Jira') {
        messages.push({ sender: 'user', text: optionText });
        generateJiraTicketDescription();
      } else {
        handleSendMessage(optionText);
      }
    };

    sendButton.addEventListener('click', () => handleSendMessage(userInput.value));
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && userInput.value.trim()) {
        handleSendMessage(userInput.value);
      }
    });

    document.addEventListener('DOMContentLoaded', initializeChat);
  </script>
</body>
</html>
